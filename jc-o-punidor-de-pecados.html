<!DOCTYPE html>
<html>
<head>
    <title>JC o punidor de pecados</title>
    <meta charset="UTF-8">
    <script src="teclado.js"></script> 
    <script src="spritesheet_jc.js"></script>
    <script src="laser.js"></script>
    <script src="aguabenta.js"></script>
    <script src="coracaodropado.js"></script>
    <script src="inimigo.js"></script>
    <script src="jc.js"></script>
    <script src="animacao.js"></script> 
    <link rel="stylesheet" href="src/style.css">
</head>
<body>
    <canvas id="canvas_jc" width="1000" height="500"></canvas>
    <script>
        var canvas = document.getElementById('canvas_jc');
        var context = canvas.getContext('2d');
        var teclado = new Teclado(document);
        var animacao = new Animacao(context, canvas);

        var imgJC = new Image();
        var imgCoracao = new Image();
        var imgInimigoPolvo = new Image();

        var imagensParaCarregar = 3;
        var imagensCarregadas = 0;
        var jc;
        // var inimigo1; // Vamos deixar o spawner automático cuidar disso por enquanto

        teclado.disparou(85, function() { // 85 é o keyCode para a tecla 'U'
            if (animacao) { // Verifica se animacao já foi inicializada
            animacao.condicaoPortao4000Liberado = true;
            console.log("CONDIÇÃO DO PORTÃO 4000 LIBERADA (via tecla U)!");
            }
            });

        function imagemCarregada() {
            imagensCarregadas++;
            // console.log('Uma imagem tentou carregar. Total agora:', imagensCarregadas, 'de', imagensParaCarregar, this.src);
            
            if (this.naturalHeight === 0 && this.complete) {
                 console.error('IMAGEM PARECE NÃO TER CARREGADO CORRETAMENTE (altura 0):', this.src);
            }

            if (imagensCarregadas === imagensParaCarregar) {
                // console.log("TODAS AS IMAGENS REGISTRADAS COMO 'PROCESSADAS'. Verificando integridade...");
                
                let jcRealmenteCarregada = imgJC.complete && imgJC.naturalHeight !== 0;
                let coracaoRealmenteCarregado = imgCoracao.complete && imgCoracao.naturalHeight !== 0;
                let inimigoRealmenteCarregado = imgInimigoPolvo.complete && imgInimigoPolvo.naturalHeight !== 0;

                if (jcRealmenteCarregada && coracaoRealmenteCarregado && inimigoRealmenteCarregado) {
                    console.log("CONFIRMADO: Todas as imagens principais carregadas com sucesso. Iniciando componentes do jogo...");
                    
                    animacao.imgCoracaoHUD = imgCoracao;
                    
                    // ================================================================
                    // ========= ADICIONE ESTAS LINHAS IMPORTANTES AQUI ↓ =============
                    // ================================================================
                    animacao.imgInimigo = imgInimigoPolvo; // Atribui a imagem do polvo carregada
                    
                    // !!! AJUSTE OS VALORES DE LINHAS E COLUNAS ABAIXO PARA A SUA IMAGEM 'inimigo_polvo.png' !!!
                    animacao.imgInimigoLinhas = 2;  // Quantas linhas tem sua spritesheet do inimigo polvo?
                    animacao.imgInimigoColunas = 4; // Quantas colunas (quadros por linha)?
                    
                    console.log("DEFINIDO PARA SPAWNER -> animacao.imgInimigo:", (animacao.imgInimigo ? animacao.imgInimigo.src : "null"), "Linhas:", animacao.imgInimigoLinhas, "Colunas:", animacao.imgInimigoColunas);
                    // ================================================================
                    // ========= FIM DAS LINHAS A ADICIONAR ↑ =========================
                    // ================================================================
                    
                    jc = new JC(context, teclado, imgJC, animacao, canvas);
                    // console.log("INSTÂNCIA DE JC CRIADA:", jc); // Log já existe
                    animacao.novoSprite(jc, true); // jc é o jogador principal

                    // Removi a criação manual do inimigo1 para deixar o spawner automático trabalhar.
                    // Se quiser um inimigo inicial, pode adicionar aqui, mas garanta que use
                    // as mesmas informações de spritesheet que o spawner usará ou ajuste conforme necessário.

                    teclado.disparou(SETA_CIMA, jc.pular.bind(jc));
                    teclado.disparou(TECLA_W, jc.pular.bind(jc));
                    teclado.disparou(ESPACO, jc.atirar.bind(jc));
                    teclado.disparou(TECLA_P, function() {
                        if (jc && !jc.estaMorto && typeof jc.receberDano === 'function') { jc.receberDano(); }
                    });
                    teclado.disparou(TECLA_R, function() {
                        if (jc && typeof jc.restaurarVidas === 'function') { jc.restaurarVidas(); }
                    });
                    
                    animacao.mundoLargura = 5000;

                    // Seus logs de diagnóstico (eles já estão no seu código)
                    console.log("--- DIAGNÓSTICO ANTES DE ANIMACAO.LIGAR() ---");
                    console.log("1. animacao.jogadorPrincipal:", animacao.jogadorPrincipal);
                    if (animacao.jogadorPrincipal) { console.log("   Tipo de jogadorPrincipal:", animacao.jogadorPrincipal.tipo); } 
                    else { console.log("   ---> animacao.jogadorPrincipal está NULO ou INDEFINIDO!"); }
                    console.log("2. animacao.imgInimigo:", animacao.imgInimigo);
                    if (animacao.imgInimigo) {
                        console.log("   animacao.imgInimigo.complete:", animacao.imgInimigo.complete);
                        console.log("   animacao.imgInimigo.naturalHeight:", animacao.imgInimigo.naturalHeight);
                        console.log("   animacao.imgInimigo.src:", animacao.imgInimigo.src);
                    } else { console.log("   ---> animacao.imgInimigo está NULO ou INDEFINIDO!"); }
                    console.log("3. animacao.imgInimigoLinhas:", animacao.imgInimigoLinhas);
                    console.log("4. animacao.imgInimigoColunas:", animacao.imgInimigoColunas);
                    console.log("--- FIM DO DIAGNÓSTICO ---");

                    animacao.ligar();
                } else {
                    let erros = "";
                    if(!jcRealmenteCarregada) erros += "Imagem JC não carregou. ";
                    if(!coracaoRealmenteCarregado) erros += "Imagem Coração não carregou. ";
                    if(!inimigoRealmenteCarregado) erros += "Imagem Inimigo Polvo não carregou. ";
                    console.error("ERRO FATAL NO CARREGAMENTO DE IMAGENS:", erros);
                    alert("Erro ao carregar imagens essenciais. Verifique o console (F12).");
                }
            }
        }

        imgJC.onload = imagemCarregada;
        imgCoracao.onload = imagemCarregada;
        imgInimigoPolvo.onload = imagemCarregada;

        imgJC.onerror = function() { console.error("ERRO no imgJC.onerror: Falha ao carregar IMAGEM JC! Caminho:", imgJC.src); imagemCarregada(); };
        imgCoracao.onerror = function() { console.error("ERRO no imgCoracao.onerror: Falha ao carregar IMAGEM DO CORAÇÃO! Caminho:", imgCoracao.src); imagemCarregada(); };
        imgInimigoPolvo.onerror = function() { console.error("MAIN: ERRO AO CARREGAR IMAGEM DO INIMIGO POLVO! Caminho:", imgInimigoPolvo.src); imagemCarregada(); };

        // console.log('Definindo src para imgJC:', 'img/JC_alpha.png'); // Logs já existem
        imgJC.src = 'img/JC_alpha.png';
        // console.log('Definindo src para imgCoracao:', 'img/vida-coracao.png');
        imgCoracao.src = 'img/vida-coracao.png';
        // console.log('Definindo src para imgInimigoPolvo:', 'img/inimigo_polvo.png');
        imgInimigoPolvo.src = 'img/inimigo_polvo.png';
        
    </script>
</body>
</html>